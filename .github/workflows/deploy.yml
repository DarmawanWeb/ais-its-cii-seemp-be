name: Deploy to Ubuntu VPS

on:
  workflow_call:
    secrets:
      VPS_HOST:
        required: true
      VPS_USERNAME:
        required: true
      VPS_SSH_KEY:
        required: true
      APP_PATH:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            bash -l -c '
              set -e
              
              echo "üîß Loading environment (nvm, pnpm, etc.)..."
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

              export PNPM_HOME="$HOME/.local/share/pnpm"
              export PATH="$PNPM_HOME:$PATH"

              echo "üìÇ Entering app directory"
              cd ${{ secrets.APP_PATH }}

              echo "üîÑ Pulling latest code"
              git pull origin main

              echo "üì¶ Installing dependencies"
              pnpm install

              echo "üî® Building project"
              pnpm build

              echo "üìÅ Creating logs directory if not exists"
              mkdir -p logs

              echo "üöÄ Deploying with PM2 using ecosystem config"
              if pm2 describe ais-be > /dev/null 2>&1; then
                echo "‚ôªÔ∏è  Restarting existing PM2 process"
                pm2 restart ecosystem.config.js --env production --update-env
              else
                echo "‚ú® Starting new PM2 process"
                pm2 start ecosystem.config.js --env production
              fi

              echo "üíæ Saving PM2 configuration"
              pm2 save

              echo "‚úÖ Deployment completed successfully"
              pm2 status
            '